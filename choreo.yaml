version: 1

# Choreo Backend Service Configuration
metadata:
  name: webgenie-backend
  description: WebGenie Backend API with Gene Regulatory Network Inference
  version: 1.0.0

# Component definition
components:
  - name: backend
    type: api
    source:
      location: ./webgenie-backend
      
# Build configuration
build:
  kind: dockerfile
  dockerfile: Dockerfile
  context: ./webgenie-backend

# Runtime configuration
runtime:
  type: python3
  version: 3.11
  port: 8000

# Exposed endpoints
endpoints:
  - name: api
    path: /api/v1
    port: 8000
    method: rest
    protocols:
      - http
      - https

# Environment variables
environment:
  DEBUG: 'False'
  LOG_LEVEL: INFO
  DATABASE_URL: ${DB_URL}
  REDIS_URL: ${REDIS_URL}
  CELERY_BROKER_URL: ${CELERY_BROKER_URL}
  CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
  DATA_DIR: /data
  RESULTS_DIR: /data/results
  DATASETS_DIR: /data/datasets
  TEMP_DIR: /tmp/webgenie
  HF_TOKEN: ${HF_TOKEN}
  USE_DOCKER: 'true'
  DOCKER_REGISTRY: grnbeeline
  CORS_ORIGINS: ${CORS_ORIGINS}

# Deployment configuration
deployment:
  replicas: 1
  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 2000m
      memory: 4Gi
  strategy:
    type: rolling
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

# Health check configuration
healthcheck:
  enabled: true
  path: /health
  initialDelay: 10
  period: 30
  timeout: 10
  threshold: 3

# Volume mounts
volumes:
  - name: data
    path: /data
    size: 10Gi
  - name: temp
    path: /tmp/webgenie
    size: 5Gi

# Dependency services
dependencies:
  - type: postgresql
    name: webgenie-db
    version: 16
    capacity: 1Gi
    
  - type: redis
    name: webgenie-redis
    version: 7-alpine
    capacity: 500Mi
