specVersion: 1.0.0
metadata:
  name: webgenie-backend
  description: FastAPI backend for WebGenie - ML dataset inference platform
  version: 1.0.0
  owner: your-org

service:
  serviceType: web
  
  containerConfig:
    image:
      name: webgenie-backend
    port: 8000
    
    env:
      # Server Configuration
      - name: LOG_LEVEL
        value: INFO
      - name: DEBUG
        value: "false"
      
      # Database Configuration
      - name: DATABASE_URL
        valueFrom:
          secretRef: DATABASE_URL
      
      # Redis Configuration
      - name: REDIS_URL
        valueFrom:
          secretRef: REDIS_URL
      - name: CELERY_BROKER_URL
        valueFrom:
          secretRef: CELERY_BROKER_URL
      - name: CELERY_RESULT_BACKEND
        valueFrom:
          secretRef: CELERY_RESULT_BACKEND
      
      # File Paths (use /tmp or persistent volumes)
      - name: DATA_DIR
        value: /data
      - name: RESULTS_DIR
        value: /data/results
      - name: DATASETS_DIR
        value: /data/datasets
      - name: TEMP_DIR
        value: /tmp/webgenie
      
      # Job Configuration
      - name: MAX_CONCURRENT_JOBS
        value: "2"
      - name: JOB_TIMEOUT_SECONDS
        value: "3600"
      
      # HuggingFace Configuration
      - name: HF_TOKEN
        valueFrom:
          secretRef: HF_TOKEN
      - name: HF_DATASET_ORG
        value: cskokgibbs
      - name: HF_DATASET_PREFIX
        value: datasets
      
      # CORS Configuration
      - name: CORS_ORIGINS
        value: '["http://localhost","http://localhost:3000","http://localhost:5173","https://webgenie-frontend.choreo.dev"]'
    
    resources:
      requests:
        memory: 2Gi
        cpu: 1000m
      limits:
        memory: 4Gi
        cpu: 2000m
    
    # Health check endpoint
    livenessProbe:
      httpGet:
        path: /health
        port: 8000
        scheme: HTTP
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
    
    readinessProbe:
      httpGet:
        path: /health
        port: 8000
        scheme: HTTP
      initialDelaySeconds: 10
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 2
  
  # Scaling configuration
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 5
    targetCPUUtilization: 70
    targetMemoryUtilization: 80
  
  # Ingress configuration (automatically managed by Choreo)
  ingress:
    enabled: true
    path: /
    
  # Buildpack configuration (Choreo will auto-detect)
  buildConfig:
    buildpack: docker
    dockerfile: Dockerfile
    context: ./webgenie-backend
